var gameLogic;!function(a){function b(){for(var a=[],b=0;136>b;b++)a[b]=b;a[136]=0;for(var b=135;b>=0;b--){var e=Math.floor(Math.random()*b),f=a[b];a[b]=a[e],a[e]=f}for(var g={hand:[],open:[]},h={hand:[],open:[]},i=[0,0,0,0,0,1,0],j={stock:a,px:g,po:h,legalMove:i,out:[],turn:-1},b=0;6>b;b++)b%2==0?c(j.stock,4,j.px):c(j.stock,4,j.po);return c(j.stock,1,j.px),c(j.stock,1,j.po),j.px.hand.sort(d),j.po.hand.sort(d),p=!0,j}function c(a,b,c){for(var d=0;b>d;d++){var e=a[a[136]]/4;c.hand.push(Math.floor(e)),a[136]++}}function d(a,b){return a-b}function e(a){for(var b=[],c=[],d=[],e=[],f=[],g=0;9>g;g++)c.push(a.reduce(function(a,b){return b==g?a+1:a},0));for(var g=9;18>g;g++)d.push(a.reduce(function(a,b){return b==g?a+1:a},0));for(var g=18;27>g;g++)e.push(a.reduce(function(a,b){return b==g?a+1:a},0));for(var g=27;34>g;g++)f.push(a.reduce(function(a,b){return b==g?a+1:a},0));return c.unshift(c.reduce(function(a,b){return a+b})),d.unshift(d.reduce(function(a,b){return a+b})),e.unshift(e.reduce(function(a,b){return a+b})),f.unshift(f.reduce(function(a,b){return a+b})),b.push(c),b.push(d),b.push(e),b.push(f),b}function f(a,b){if(0===a[0])return!0;for(var c=0,d=1;d<a.length;d++)if(0!==a[d]){c=d;break}var e=!1;return a[c]>=3?(a[c]-=3,a[0]-=3,e=f(a,b),a[c]+=3,a[0]+=3,e):!b&&8>c&&a[c+1]>0&&a[c+2]>0?(a[c]=a[c]-1,a[c+1]=a[c+1]-1,a[c+2]=a[c+2]-1,a[0]=a[0]-3,e=f(a,b),a[c]=a[c]+1,a[c+1]=a[c+1]+1,a[c+2]=a[c+2]+1,a[0]=a[0]+3,e):!1}function g(a,b){var c=angular.copy(a);if(c.push(b),-1==[5,8,11,14].indexOf(c.length))throw console.log("Hu length of arr is illegal."),"Hu number of cards is illegal";for(var d=e(c),g=-1,h=!1,i=0;4>i;i++){var j=d[i][0]%3;if(1==j)return!1;if(2==j){if(h)return!1;g=i,h=!0}}if(!h)return!1;for(var i=0;4>i;i++)if(g!=i&&!f(d[i],3==i))return!1;for(var k=d[g],i=1;i<k.length;i++)if(k[i]>=2){if(k[i]-=2,k[0]-=2,f(k,3==g))return!0;k[i]+=2,k[0]+=2}return!1}function h(a,b){if(-1==[4,7,10,13].indexOf(a.length))throw console.log("Chi length of arr is illegal."),"Chi number of cards is illegal";var c=e(a),d=Math.floor(b/9),f=b%9;if(3==d)return[0,0,0];var g=c[d],h=0,i=0,j=0;return f>=2&&g[f]>=1&&g[f-1]>=1&&(j=1),f>=1&&7>=f&&g[f]>=1&&g[f+2]>=1&&(i=1),6>=f&&g[f+2]>=1&&g[f+3]>=1&&(h=1),[h,i,j]}function i(a,b){if(-1==[4,7,10,13].indexOf(a.length))throw console.log("Peng length of arr is illegal."),"Peng number of cards is illegal";return a.reduce(function(a,c){return c==b?a+1:a},0)>=2}function j(){return{board:b(),delta:null}}function k(a){return a.stock[136]>=136&&0===a.legalMove[5]}function l(a,b,e,f){a||(a=j());var g,h=a.board,i=angular.copy(h),l=1===i.turn||2===i.turn?"O":"X",o=f;4===b?(o=-1,i.turn=-1,1!==h.turn&&3!==h.turn||("X"===l?i.px.hand.push(e):i.po.hand.push(e)),g="X"===l?[1,0]:[0,1]):5===b&&k(h)?(i.turn=-1,o=-1,g=[0,0]):(i.turn=(i.turn+1)%4,g=null);var p="X"===l?i.px:i.po;"X"===l?i.po:i.px;if(0===b){var q=[e+1,e+2,e];m(p,q)}if(1===b){var q=[e-1,e+1,e];m(p,q)}if(2===b){var q=[e-1,e-2,e];m(p,q)}if(3===b){var q=[e,e,e];m(p,q)}if((3>=b||4===b&&(1===h.turn||3===h.turn))&&i.out.pop(),5===b&&(c(i.stock,1,p),e=p.hand[p.hand.length-1]),6===b){var r=p.hand.indexOf(e);if(-1===r)throw new Error("This pai does not belong to player x");p.hand.splice(r,1),p.hand.sort(d),i.out.push(e),o=(f+1)%2}var s=0===o?angular.copy(i.px.hand):angular.copy(i.po.hand),t=5===b?s.pop():e;i.legalMove=n(s,t,b,i.turn%2);var u=angular.copy(p.hand);if(5===b){var v=u.pop();p.hand=u.sort(d),p.hand.push(v)}else p.hand=u.sort(d);var w={pai:e,movetype:b},x={delta:w,board:i};return{endMatchScores:g,turnIndexAfterMove:o,stateAfterMove:x}}function m(a,b){for(var c=0;2>c;c++){var e=a.hand.indexOf(b[c]);if(-1===e)throw new Error("MovePaitoOPEN is illegal"+a.hand);a.hand.splice(e,1)}b.sort(d);for(var c=0;3>c;c++)a.open.push(b[c])}function n(a,b,c,d){var e=[];return 1===d?(e=h(a,b),i(a,b)?e.push(1):e.push(0),g(a,b)?e.push(1):e.push(0),e.push(1),e.push(0)):(e=[0,0,0,0],5!==c&&6!==c||!g(a,b)?e.push(0):e.push(1),e.push(0),e.push(1)),e}function o(a){var b=a.turnIndexBeforeMove,c=a.stateBeforeMove;if(c){var d=a.move,e=a.move.stateAfterMove.delta,f=e.pai,g=e.movetype,h=l(c,g,f,b);if(!angular.equals(d,h))throw new Error("Expected move="+angular.toJson(h,!0)+", but got stateTransition="+angular.toJson(a.move,!0))}}var p=!1;a.getInitialState=j,a.createMove=l,a.checkMoveOk=o}(gameLogic||(gameLogic={}));var game;!function(a){function b(){translate.setTranslations(c()),translate.setLanguage("en"),log.log("Translation of 'RULES_OF_MAHJONG' is "+translate("RULES_OF_MAHJONG")),resizeGameAreaService.setWidthToHeight(1.5),moveService.setGame({minNumberOfPlayers:2,maxNumberOfPlayers:2,checkMoveOk:gameLogic.checkMoveOk,updateUI:g}),document.addEventListener("animationend",d,!1),document.addEventListener("webkitAnimationEnd",d,!1),document.addEventListener("oanimationend",d,!1);var a=window;a.HTMLInspector&&setInterval(function(){a.HTMLInspector.inspect({excludeRules:["unused-classes","script-placement"]})},3e3)}function c(){return{RULES_OF_MAHJONG:{en:"Rules of Mahjong",ch:"麻将规则"},RULES_SLIDE1:{en:"Try to match you tiles to a pattern that can HU by moves including CHI, PONG, ZHUA, DA",ch:"通过不断抓、打、吃、碰达到和牌的目的。"},RULES_SLIDE2:{en:"Your tiles should include ONE pair, and the rest match XXX or XYZ pattern.",ch:"和牌需要有一对将牌，其余的满足三个相同牌或者三个连续牌。"},CLOSE:{en:"Close",ch:"关闭"}}}function d(){$rootScope.$apply(function(){log.info("Animation ended"),a.animationEnded=!0,e()})}function e(){a.isComputerTurn&&(a.isComputerTurn=!1,moveService.makeMove(aiService.findComputerMove(a.move)))}function f(a){for(var b=[],c=0;a>c;c++)b.push(c);return b}function g(b){log.info("Game got updateUI:",b),a.animationEnded=!1,a.move=b.move,a.state=a.move.stateAfterMove,a.state||(a.state=gameLogic.getInitialState()),a.ifEnd=-1==b.move.turnIndexAfterMove,a.canMakeMove=a.move.turnIndexAfterMove>=0&&b.yourPlayerIndex===a.move.turnIndexAfterMove,a.canMakeMove&&(a.canSelectPai=a.state.board.turn%2===0),a.cpai=a.state.board.out[a.state.board.out.length-1],a.paiLeft=136-a.state.board.stock[136],a.player=0===b.yourPlayerIndex?a.state.board.px:a.state.board.po,a.opp=0===b.yourPlayerIndex?a.state.board.po:a.state.board.px,a.chand=a.player.hand,a.ohand=a.opp.hand,a.playerHandLength=a.chand.length,a.opponentHandLength=a.opp.hand.length,a.playerOpenLength=a.player.open.length,a.opponentOpenLength=a.opp.open.length,a.outLength=a.state.board.out.length,a.handindex=f(a.chand.length),a.opphandindex=f(a.opp.hand.length),a.openindex=f(a.player.open.length),a.oppopenindex=f(a.opp.open.length),a.outindex=f(a.outLength),a.isComputerTurn=a.canMakeMove&&""===b.playersInfo[b.yourPlayerIndex].playerId,a.isComputerTurn&&(a.canMakeMove=!1,a.state.delta||e())}function h(b){a.canSelectPai&&(a.paiSelected=a.chand[b],a.selectedIndex=b)}function i(b){if(6===b){if(null===a.paiSelected)return void log.info("You need to select a Pai Before DA");a.cpai=a.paiSelected}else 5===b&&(a.cpai=null);if(log.info("Making move ",a.MOVE[b]),a.canMakeMove)try{var c=gameLogic.createMove(a.state,b,a.cpai,a.move.turnIndexAfterMove);a.canMakeMove=!1,moveService.makeMove(c)}catch(d){return void log.info(["something funny is happenning ...",b,a.cpai])}}function j(b){return a.canMakeMove?1===a.state.board.legalMove[b]:!1}function k(b){return b.target===b.currentTarget&&(b.preventDefault(),b.stopPropagation(),a.isHelpModalShown=!1),!0}a.animationEnded=!1,a.canMakeMove=!1,a.isComputerTurn=!1,a.move=null,a.isHelpModalShown=!1,a.paiSelected=null,a.cpai=null,a.chand=null,a.ohand=null,a.handindex=null,a.opphandindex=null,a.openindex=null,a.oppopenindex=null,a.playerHandLength=null,a.opponentHandLength=null,a.playerOpenLength=null,a.opponentOpenLength=null,a.outLength=null,a.outindex=null,a.player=null,a.opp=null,a.selectedIndex=-1,a.ifEnd=!1,a.paiLeft=null,a.canSelectPai=!1,a.MOVE=["LCHI","MCHI","RCHI","PENG","HU","ZHUA","DA"],a.init=b,a.paiClicked=h,a.optionClicked=i,a.ifLegalMove=j,a.clickedOnModal=k}(game||(game={})),angular.module("myApp",["ngTouch","ui.bootstrap","gameServices"]).run(function(){$rootScope.game=game,game.init()});var aiService;!function(a){function b(a){return d(a,{millisecondsLimit:1e3})}function c(a,b){for(var c=[],d=0;d<gameLogic.ROWS;d++)for(var e=0;e<gameLogic.COLS;e++)try{c.push(gameLogic.createMove(a,d,e,b))}catch(f){}return c}function d(a,b){return alphaBetaService.alphaBetaDecision(a,a.turnIndexAfterMove,f,e,null,b)}function e(a,b){var c=a.endMatchScores;return c?c[0]>c[1]?Number.POSITIVE_INFINITY:c[0]<c[1]?Number.NEGATIVE_INFINITY:0:0}function f(a,b){return c(a.stateAfterMove,b)}a.findComputerMove=b,a.getPossibleMoves=c,a.createComputerMove=d}(aiService||(aiService={}));
//# sourceMappingURL=everything.min.js.map