describe("In Mahjong", function() {
  let OK = true;
  let ILLEGAL = false;
  let X_ZHUA_TURN = 0;
  let X_DA_TURN = 0;
  let O_ZHUA_TURN = 1;
  let O_DA_TURN = 1;
  let NO_ONE_TURN = -1;
  let NO_ONE_WINS: number[] = null;
  let X_WIN_SCORES = [1, 0];
  let O_WIN_SCORES = [0, 1];
  let TIE_SCORES = [0, 0];
  let INITIAL_BOARD : Board = {
    stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,26],
    px:{
      hand:[0,0,3,9,13,13,14,20,20,21,22,23,26],
      open:[]
    },
    po:{
      hand:[0,1,1,3,6,10,11,17,19,20,24,30,30],
      open:[]
    },
    legalMove:[0,0,0,0,0,1,0],
    out:[],
    turn: -1
  };
  
  function expectMove(
      isOk: boolean,
      turnIndexBeforeMove: number,
      boardBeforeMove: Board,
      pai: number,
      movetype: number,
      boardAfterMove: Board,
      turnIndexAfterMove: number,
      endMatchScores: number[]): void {
    let stateTransition: IStateTransition = {
      turnIndexBeforeMove: turnIndexBeforeMove,
      stateBeforeMove: boardBeforeMove ? {board: boardBeforeMove, delta: null} : null,
      move: {
        endMatchScores: endMatchScores,
        turnIndexAfterMove: turnIndexAfterMove,
        stateAfterMove: {delta: {pai: pai, movetype: movetype}, board: boardAfterMove}
      },
      numberOfPlayers: null
    };
    let numberOfTimesCalledRandom = 0;
    Math.random = function () {
      numberOfTimesCalledRandom++;
      if (numberOfTimesCalledRandom <= 136) return 1;
      throw new Error("Called Math.random more times than expected");
    };
    if (isOk) {
      gameLogic.checkMoveOk(stateTransition);
    } else {
      // We expect an exception to be thrown :)
      let didThrowException = false;
      try {
        gameLogic.checkMoveOk(stateTransition);
      } catch (e) {
        didThrowException = true;
      }
      if (!didThrowException) {
        throw new Error("We expect an illegal move, but checkMoveOk didn't throw any exception!")
      }
    }
  }
  
  it("Can get an initiallized board if no state exist", function() {
    
  });

  it("Player X make move ZHUA after initiallize is legal", function() {
    expectMove(OK, 0, INITIAL_BOARD, 15, 5,
      {
    stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
    px:{
      hand:[0,0,3,9,13,13,14,20,20,21,22,23,26,15],
      open:[]
    },
    po:{
      hand:[0,1,1,3,6,10,11,17,19,20,24,30,30],
      open:[]
    },
    legalMove:[0,0,0,0,0,0,1],
    out:[],
    turn: 0
  }, 0, NO_ONE_WINS);
  });
  
  it("Player O make move ZHUA after initiallize is illegal", function() {
    expectMove(ILLEGAL, 0, INITIAL_BOARD, 15, 5,
      {
    stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
    px:{
      hand:[0,0,3,9,13,13,14,20,20,21,22,23,26],
      open:[]
    },
    po:{
      hand:[0,1,1,3,6,10,11,17,19,20,24,30,30,15],
      open:[]
    },
    legalMove:[0,0,0,0,0,0,1],
    out:[],
    turn: 0
  }, O_DA_TURN, NO_ONE_WINS);
  });
  
  it("Player X make move Da after ZHUA is legal", function() {
    expectMove(OK, 0, {
      stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
      px:{
        hand:[1,1,6,9,10,11,13,17,19,20,21,24,26,30,30],
        open:[]
      },
      po:{
        hand:[0,0,0,3,3,13,14,15,20,20,22,23,24],
        open:[]
      },
      legalMove:[0,0,0,0,0,0,1],
      out:[],
      turn: 0
    },
    20, 6, {
      stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
      px:{
        hand:[1,1,6,9,10,11,13,17,19,21,24,26,30,30],
        open:[]
      },
      po:{
        hand:[0,0,0,3,3,13,14,15,20,20,22,23,24],
        open:[]
      },
      legalMove:[0,0,0,1,1,1,0],
      out:[20],
      turn: 1
    }, 1, NO_ONE_WINS);
  });

  it("Player O make move CHI after DA by X is legal", function() {
    expectMove(OK, 1, {
      stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
      px:{
        hand:[0,0,3,9,13,13,14,15,20,20,22,23,26],
        open:[]
      },
      po:{
        hand:[0,1,1,3,6,10,11,17,19,20,24,30,30],
        open:[]
      },
      legalMove:[0,0,1,0,0,1,0],
      out:[21],
      turn: 1
    },
    21, 2, {
      stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
      px:{
        hand:[0,0,3,9,13,13,14,15,20,20,22,23,26],
        open:[]
      },
      po:{
        hand:[0,1,1,3,6,10,11,17,24,30,30],
        open:[19,20,21]
      },
      legalMove:[0,0,0,0,0,0,1],
      out:[],
      turn: 2
    }, O_DA_TURN, NO_ONE_WINS);
  });
  
  it("Player O make move PENG after DA by X is legal", function() {
    expectMove(OK, O_ZHUA_TURN, {
      stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
      px:{
        hand:[0,1,1,3,6,10,11,17,19,21,24,30,30],
        open:[]
      },
      po:{
        hand:[0,0,3,9,13,13,14,15,20,20,22,23,26],
        open:[]
      },
      legalMove:[0,0,0,1,0,1,0],
      out:[20],
      turn: 1
    },
    20, 3, {
      stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
      px:{
        hand:[0,1,1,3,6,10,11,17,19,21,24,30,30],
        open:[]
      },
      po:{
        hand:[0,0,3,9,13,13,14,15,22,23,26],
        open:[20,20,20]
      },
      legalMove:[0,0,0,0,0,0,1],
      out:[],
      turn: 2
    }, O_DA_TURN, NO_ONE_WINS);
  });
  
  it("Player O make move HU after DA by X is legal", function() {
    expectMove(OK, O_ZHUA_TURN, {
      stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
      px:{
        hand:[1,1,6,9,10,11,13,17,19,21,24,26,30,30],
        open:[]
      },
      po:{
        hand:[0,0,0,3,3,13,14,15,20,20,22,23,24],
        open:[]
      },
      legalMove:[0,0,0,1,1,1,0],
      out:[20],
      turn: 1
    },
    20, 4, {
      stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
      px:{
        hand:[1,1,6,9,10,11,13,17,19,21,24,26,30,30],
        open:[]
      },
      po:{
        hand:[0,0,0,3,3,13,14,15,20,20,22,23,24],
        open:[]
      },
      legalMove:[0,0,0,0,0,0,1],
      out:[20],
      turn: -1
    }, NO_ONE_TURN, O_WIN_SCORES);
  });
  
  it("Special case can HU", function() {
    expectMove(OK, O_ZHUA_TURN, {
      stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
      px:{
        hand:[1,1,3,3,6,9,10,11,13,17,19,21,24,26],
        open:[]
      },
      po:{
        hand:[4,5,6,12,13,14,19],
        open:[1,2,3,18,18,18]
      },
      legalMove:[0,0,0,1,1,1,0],
      out:[19],
      turn: 1
    },
    20, 4, {
      stock:[2,92,80,15,7,98,122,13,3,81,53,106,76,6,41,71,59,54,87,89,47,1,25,121,38,83,60,37,58,24,8,28,94,84,118,44,108,20,57,51,11,77,129,39,62,115,40,117,78,75,72,112,67,61,128,69,85,5,104,19,70,124,23,10,46,16,100,68,74,9,123,63,131,50,111,135,29,107,34,88,21,32,31,82,30,42,14,90,49,134,22,27,86,132,56,35,96,45,52,91,66,43,102,99,79,116,97,109,133,110,126,113,17,33,0,36,127,103,95,64,125,130,93,73,18,65,120,105,101,4,55,119,114,12,26,48,27],
      px:{
        hand:[1,1,3,3,6,9,10,11,13,17,19,21,24,26],
        open:[]
      },
      po:{
        hand:[4,5,6,12,13,14,19],
        open:[1,2,3,18,18,18]
      },
      legalMove:[0,0,0,0,0,0,1],
      out:[19],
      turn: -1
    }, NO_ONE_TURN, O_WIN_SCORES);
  });

  
});
